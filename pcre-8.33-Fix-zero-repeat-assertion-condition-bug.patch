From db5ce1f052c354faff0b74832934659753dfaae7 Mon Sep 17 00:00:00 2001
From: ph10 <ph10@2f5784b3-3f2a-0410-8824-cb99058d5e15>
Date: Wed, 19 Nov 2014 20:57:13 +0000
Subject: [PATCH] Fix zero-repeat assertion condition bug.
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

git-svn-id: svn://vcs.exim.org/pcre/code/trunk@1513 2f5784b3-3f2a-0410-8824-cb99058d5e15
Signed-off-by: Petr Písař <ppisar@redhat.com>

Petr Pisar: Ported to 8.33.

Signed-off-by: Petr Písař <ppisar@redhat.com>
---
 pcre_exec.c          |  4 +++-
 testdata/testinput2  |  6 ++++++
 testdata/testoutput2 | 10 ++++++++++
 3 files changed, 19 insertions(+), 1 deletion(-)

Index: pcre-8.31/pcre_exec.c
===================================================================
--- pcre-8.31.orig/pcre_exec.c
+++ pcre-8.31/pcre_exec.c
@@ -1441,7 +1441,9 @@ for (;;)
         if (md->end_offset_top > offset_top)
           offset_top = md->end_offset_top;  /* Captures may have happened */
         condition = TRUE;
-        ecode += 1 + LINK_SIZE + GET(ecode, LINK_SIZE + 2);
+        ecode += 1 + LINK_SIZE;
+        if (*ecode == OP_BRAZERO) ecode++;
+        ecode += GET(ecode, 1);
         while (*ecode == OP_ALT) ecode += GET(ecode, 1);
         }
 
Index: pcre-8.31/testdata/testinput2
===================================================================
--- pcre-8.31.orig/testdata/testinput2
+++ pcre-8.31/testdata/testinput2
@@ -3769,4 +3769,10 @@ assertion, and therefore fails the entir
 /((?=a(*COMMIT)b)ab|ac){0}(?:(?1)|a(c))/
     ac 
 
+"((?=(?(?=(?(?=(?(?=())))*)))))"
+    a
+
+"(?(?=)?==)(((((((((?=)))))))))"
+    a
+
 /-- End of testinput2 --/
Index: pcre-8.31/testdata/testoutput2
===================================================================
--- pcre-8.31.orig/testdata/testoutput2
+++ pcre-8.31/testdata/testoutput2
@@ -12361,4 +12361,14 @@ assertion, and therefore fails the entir
     ac 
  0: ac
 
+"((?=(?(?=(?(?=(?(?=())))*)))))"
+    a
+ 0: 
+ 1: 
+ 2: 
+
+"(?(?=)?==)(((((((((?=)))))))))"
+    a
+No match
+
 /-- End of testinput2 --/
